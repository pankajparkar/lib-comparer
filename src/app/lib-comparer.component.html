<div class="hero-section">
  <div class="hero-content">
    <div class="hero-badge">
      <span class="badge-icon">ðŸš€</span>
      <span>Open Source Tool</span>
    </div>
    <h1 class="hero-title">
      Find the Perfect
      <span class="gradient-text">Library</span>
      for Your Project
    </h1>
    <p class="hero-description">
      Compare libraries and frameworks with real-time GitHub & npm statistics.
      Make informed decisions with security insights, bundle sizes, and community metrics.
    </p>
  </div>
</div>

<div class="search-section">
  <div class="search-container">

    @let isLoading = this.recResource.isLoading();
    @let err = this.recResource.error();
    @let recommendations = this.recResource.value();

    <form (ngSubmit)="searchLibraries()" class="search-form">
      <div class="form-grid">
        <div class="form-field">
          <label for="framework" class="field-label">
            <span class="label-icon">âš¡</span>
            Framework
          </label>
          <div class="select-wrapper">
            <select id="framework" [(ngModel)]="selectedFramework" name="framework" required class="form-select">
              <option value="" disabled selected>Choose your framework</option>
              @for(fw of frameworks; track fw) {
              <option [value]="fw">{{ fw }}</option>
              }
            </select>
            <svg class="select-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor"
              stroke-width="2">
              <path d="M6 8l4 4 4-4" />
            </svg>
          </div>
        </div>

        <div class="form-field">
          <label for="functionality" class="field-label">
            <span class="label-icon">ðŸŽ¯</span>
            What do you need?
          </label>
          <input id="functionality" type="text" [(ngModel)]="functionality" name="functionality"
            placeholder="e.g. datepicker, chart, form validation" required class="form-input" />
        </div>

        <div class="form-field form-field-button">
          <button type="submit" [disabled]="isLoading" class="search-button">
            @if(!isLoading) {
            <svg class="button-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <span>Find Libraries</span>
            }
            @if(isLoading) {
            <svg class="button-icon loading" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56" />
            </svg>
            <span>Searching...</span>
            }
          </button>
        </div>
      </div>

      <lc-ai-assist [frameworks]="frameworks" (extracted)="onAIExtract($event)"></lc-ai-assist>
    </form>
  </div>
</div>

@if(err) {
<div class="error-container">
  <div class="error-banner">
    <svg class="error-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2">
      <circle cx="12" cy="12" r="10" />
      <line x1="15" y1="9" x2="9" y2="15" />
      <line x1="9" y1="9" x2="15" y2="15" />
    </svg>
    <div class="error-content">
      <h3>Oops! Something went wrong</h3>
      <p>{{ err.message }}</p>
    </div>
  </div>
</div>
}

@if(recommendations?.length ?? 0 > 0) {
<div class="results-section">
  <div class="results-header">
    <div class="results-title">
      <h2>Recommended Libraries</h2>
      <span class="results-count">{{ recommendations?.length || 0 }} found</span>
    </div>

    <div class="sort-controls">
      <span class="sort-label">Sort by:</span>
      <div class="sort-buttons">
        <button type="button" class="sort-button" [class.active]="sortBy() === 'score'" (click)="setSort('score')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6" />
          </svg>
          Best Match
        </button>
        <button type="button" class="sort-button" [class.active]="sortBy() === 'stars'" (click)="setSort('stars')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon
              points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
          </svg>
          Stars
        </button>
        <button type="button" class="sort-button" [class.active]="sortBy() === 'downloads'"
          (click)="setSort('downloads')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            <polyline points="3.27,6.96 12,12.01 20.73,6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          Downloads
        </button>
        <button type="button" class="sort-button" [class.active]="sortBy() === 'recent'" (click)="setSort('recent')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12,6 12,12 16,14" />
          </svg>
          Recent
        </button>
      </div>
    </div>
  </div>

  <div class="libraries-grid">
    @for(lib of recommendations; track lib.name) {
    <div class="library-card">
      <div class="card-header">
        <div class="library-info">
          <h3 class="library-name">
            <a [href]="lib.repoUrl" target="_blank" rel="noopener">{{ lib.name }}</a>
          </h3>
          <div class="library-badges">
            @if(lib.vulnerable !== undefined) {
            <span class="security-badge" [class.secure]="!lib.vulnerable" [class.vulnerable]="lib.vulnerable"
              [class.critical]="lib.maxSeverityLabel==='critical'" [class.high]="lib.maxSeverityLabel==='high'"
              [class.medium]="lib.maxSeverityLabel==='medium'"
              [title]="!lib.vulnerable ? 'No known vulnerabilities' : (lib.vulnCount + ' vulnerability(ies); highest: ' + lib.maxSeverityLabel + (lib.maxCvss ? ' (CVSS ' + lib.maxCvss + ')' : ''))">
              @if(!lib.vulnerable) {
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
              </svg>
              Secure
              }
              @if(lib.vulnerable) {
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
              </svg>
              {{ lib.vulnCount }} vuln{{ lib.vulnCount === 1 ? '' : 's' }}
              }
            </span>
            }
            <a [href]="lib.npmUrl" target="_blank" rel="noopener" class="npm-badge">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M1.763 0C.786 0 0 .786 0 1.763v20.474C0 23.214.786 24 1.763 24h20.474c.977 0 1.763-.786 1.763-1.763V1.763C24 .786 23.214 0 22.237 0H1.763zM5.13 5.323l13.837.019-.009 13.836h-3.464l.01-10.382h-3.456L12.04 19.17H5.13V5.323z" />
              </svg>
              npm
            </a>
          </div>
        </div>
      </div>
      <div class="card-stats">
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon
                  points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ lib.stars | number }}</span>
              <span class="stat-label">Stars</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ lib.downloads | number }}</span>
              <span class="stat-label">Downloads</span>
            </div>
          </div>

          @if(lib.bundleSize || lib.gzipSize) {
          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">
                @if(lib.bundleSize) { {{ (lib.bundleSize!/1024) | number:'1.0-1' }}kB }
                @if(lib.gzipSize) { ({{ (lib.gzipSize!/1024) | number:'1.0-1' }}kB gz) }
              </span>
              <span class="stat-label">Bundle Size</span>
            </div>
          </div>
          }

          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 19c-5 0-7-3-7-3s2-3 7-3 7 3 7 3-2 3-7 3z" />
                <path d="M9 19c0-5 3-7 3-7s3 2 3 7-2 7-3 7-3-2-3-7z" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ lib.forks | number }}</span>
              <span class="stat-label">Forks</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ lib.issues | number }}</span>
              <span class="stat-label">Issues</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12,6 12,12 16,14" />
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-value">{{ lib.lastActivity | date:'MMM d' }}</span>
              <span class="stat-label">Updated</span>
            </div>
          </div>
        </div>

        @if(lib.coveragePct !== undefined) {
        <div class="coverage-section">
          <div class="coverage-header">
            <span class="coverage-label">Test Coverage</span>
            <span class="coverage-value" [class.good]="lib.coveragePct >= 80"
              [class.ok]="lib.coveragePct >= 50 && lib.coveragePct < 80" [class.low]="lib.coveragePct < 50">
              {{ lib.coveragePct | number:'1.0-1' }}%
            </span>
          </div>
          <div class="coverage-bar">
            <div class="coverage-fill" [style.width.%]="lib.coveragePct" [class.good]="lib.coveragePct >= 80"
              [class.ok]="lib.coveragePct >= 50 && lib.coveragePct < 80" [class.low]="lib.coveragePct < 50"></div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>

  <div class="load-more-section">
    <button type="button" class="load-more-button" (click)="loadMore()" [disabled]="isLoading">
      @if(!isLoading) {
      <svg class="button-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
        <path d="M21 3v5h-5" />
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
        <path d="M3 21v-5h5" />
      </svg>
      <span>Load More</span>
      }
      @if(isLoading) {
      <svg class="button-icon loading" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2">
        <path d="M21 12a9 9 0 11-6.219-8.56" />
      </svg>
      <span>Loading...</span>
      }
    </button>
  </div>
</div>
}

@if(!isLoading && recommendations?.length === 0 && selectedFramework && functionality) {
<div class="no-results-section">
  <div class="no-results-content">
    <svg class="no-results-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5">
      <circle cx="11" cy="11" r="8" />
      <path d="m21 21-4.35-4.35" />
      <line x1="11" y1="8" x2="11" y2="14" />
      <line x1="8" y1="11" x2="14" y2="11" />
    </svg>
    <h3>No libraries found</h3>
    <p>We couldn't find any libraries matching your criteria. Try adjusting your search terms or framework selection.
    </p>
    <div class="no-results-suggestions">
      <span>Suggestions:</span>
      <ul>
        <li>Check your spelling</li>
        <li>Try different keywords</li>
        <li>Select a different framework</li>
        <li>Use more general terms</li>
      </ul>
    </div>
  </div>
</div>
}

@if(isLoading) {
<div class="loading-section">
  <div class="loading-content">
    <svg class="loading-spinner" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2">
      <path d="M21 12a9 9 0 11-6.219-8.56" />
    </svg>
    <h3>Finding the best libraries...</h3>
    <p>Analyzing GitHub repositories and npm packages</p>
  </div>
  <lc-recommendation-shimmer [count]="4"></lc-recommendation-shimmer>
</div>
}