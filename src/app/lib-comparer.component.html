<lc-navbar title="Lib Comparer" logoSrc="/assets/logo.svg" repoUrl="https://github.com/pankajparkar/lib-comparer" />

<div class="lib-comparer-container">
  <header class="lib-comparer-header">
  <img src="/assets/logo.svg" alt="Lib Comparer Logo" width="40" height="40" />
    <h1>Library & Framework Comparer</h1>
    <p class="subtitle">Find the best libraries for your needs, with real-time stats from GitHub & npm.</p>
  </header>

  @let isLoading = this.recResource.isLoading();
  @let err = this.recResource.error();
  @let recommendations = this.recResource.value();
  <form (ngSubmit)="searchLibraries()" class="lib-comparer-form">
    <div class="form-group">
      <label for="framework">Library/Framework</label>
      <select id="framework" [(ngModel)]="selectedFramework" name="framework" required>
        <option value="" disabled selected>Select a framework</option>
        @for(fw of frameworks; track fw) {
          <option [value]="fw">{{ fw }}</option>
        }
      </select>
    </div>
    <div class="form-group">
      <label for="functionality">Functionality</label>
      <input id="functionality" type="text" [(ngModel)]="functionality" name="functionality" placeholder="e.g. datepicker, select" required />
    </div>
    <button type="submit" [disabled]="isLoading" class="primary-btn">
      @if(!isLoading) {
        <span>🔍 Recommend</span>
      }
      @if(isLoading) {
        <span>⏳ Loading...</span>
      }
    </button>
  </form>

  @if(err) {
    <div class="error-banner">API error: {{ err.message }}</div>
  }

  @if(recommendations?.length ?? 0 > 0) {
    <div class="sort-bar">
      <span>Sort by:</span>
      <button type="button" class="chip" [class.active]="sortBy() === 'score'" (click)="setSort('score')">Best</button>
      <button type="button" class="chip" [class.active]="sortBy() === 'stars'" (click)="setSort('stars')">Stars</button>
      <button type="button" class="chip" [class.active]="sortBy() === 'downloads'" (click)="setSort('downloads')">Downloads</button>
      <button type="button" class="chip" [class.active]="sortBy() === 'recent'" (click)="setSort('recent')">Recent</button>
    </div>
  }

  @if(recommendations?.length ?? 0 > 0) {
    <section class="recommendations">
      <h2>Top Recommendations</h2>
      <div class="card-list">
        @for(lib of recommendations; track lib.name) {
          <div class="lib-card">
            <div class="lib-card-header">
              <h3>
                <a [href]="lib.repoUrl" target="_blank" rel="noopener">{{ lib.name }}</a>
              </h3>
              @if(lib.vulnerable !== undefined) {
                <span class="sec-indicator"
                  [class.ok]="!lib.vulnerable"
                  [class.warn]="lib.vulnerable"
                  [class.critical]="lib.maxSeverityLabel==='critical'"
                  [class.high]="lib.maxSeverityLabel==='high'"
                  [class.medium]="lib.maxSeverityLabel==='medium'"
                  [title]="!lib.vulnerable ? 'No known vulnerabilities' : (lib.vulnCount + ' vulnerability(ies); highest: ' + lib.maxSeverityLabel + (lib.maxCvss ? ' (CVSS ' + lib.maxCvss + ')' : ''))">
                  @if(!lib.vulnerable) { 🛡 }
                  @if(lib.vulnerable) { 🛡 {{ lib.vulnCount }} }
                </span>
              }
              <a [href]="lib.npmUrl" target="_blank" rel="noopener" class="npm-link">NPM</a>
            </div>
            <ul class="lib-stats">
              <li><span class="stat-label">⭐ Stars:</span> <strong>{{ lib.stars | number }}</strong></li>
              <li><span class="stat-label">⬇️ NPM Downloads:</span> <strong>{{ lib.downloads | number }}</strong></li>
              @if(lib.bundleSize || lib.gzipSize) {
                <li><span class="stat-label">📦 Bundle:</span>
                  <strong>
                    @if(lib.bundleSize) { min {{ (lib.bundleSize!/1024) | number:'1.0-1' }} kB }
                    @if(lib.gzipSize) {, gzip {{ (lib.gzipSize!/1024) | number:'1.0-1' }} kB }
                  </strong>
                  <span class="help" title="Bundle sizes from BundleJS; gzip may be computed in-browser and can vary slightly.">ⓘ</span>
                </li>
              }
              @else {
                <li><span class="stat-label">📦 Repo Size:</span> <strong>{{ lib.size }}</strong></li>
              }
              <li><span class="stat-label">🍴 Forks:</span> <strong>{{ lib.forks | number }}</strong></li>
              <li><span class="stat-label">🐛 Issues:</span> <strong>{{ lib.issues | number }}</strong></li>
              <li><span class="stat-label">🕒 Last Activity:</span> <strong>{{ lib.lastActivity | date:'mediumDate' }}</strong></li>
              <li><span class="stat-label">👀 Watchers:</span> <strong>{{ lib.users | number }}</strong></li>
              @if(lib.coveragePct !== undefined) {
                <li><span class="stat-label">🧪 Coverage:</span>
                  <strong>
                    <span class="cov-badge" [class.good]="lib.coveragePct >= 80" [class.ok]="lib.coveragePct >= 50 && lib.coveragePct < 80" [class.low]="lib.coveragePct < 50" title="Source: {{ lib.coverageSource || 'unknown' }}">{{ lib.coveragePct | number:'1.0-1' }}%</span>
                  </strong>
                </li>
              }
              @if(lib.vulnerable !== undefined) {
                <li><span class="stat-label">🛡 Security:</span>
                  <strong>
                    @if(!lib.vulnerable) { <span class="sec-badge ok" title="No known vulnerabilities via OSV.dev">Secure</span> }
                    @if(lib.vulnerable) {
                      <span class="sec-badge warn" [class.critical]="lib.maxSeverityLabel==='critical'" [class.high]="lib.maxSeverityLabel==='high'" [class.medium]="lib.maxSeverityLabel==='medium'" [title]="lib.vulnCount + ' vulnerability(ies); highest: ' + lib.maxSeverityLabel + (lib.maxCvss ? ' (CVSS ' + lib.maxCvss + ')' : '')">{{ lib.vulnCount }} vuln{{ lib.vulnCount === 1 ? '' : 's' }} ({{ lib.maxSeverityLabel }})</span>
                    }
                  </strong>
                </li>
              }
            </ul>
          </div>
        }
      </div>
    </section>
    <div class="load-more-row">
      <button type="button" class="primary-btn" (click)="loadMore()" [disabled]="isLoading">Load more</button>
    </div>
  }

  @if(!isLoading && recommendations?.length === 0 && selectedFramework && functionality) {
    <section class="no-results">
      <p>No recommendations found. Try a different query.</p>
    </section>
  }

  @if(isLoading) {
  <div class="loading">Loading recommendations...</div>
  <lc-recommendation-shimmer [count]="4"></lc-recommendation-shimmer>
  }
</div>
